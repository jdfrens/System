require 'autotest/redgreen'
require 'autotest/timestamp'

module Autotest::Growl
  # save the name of the working directory (e.g., the app name)
  # to be used as a key to identify this particular run of autotest
  # so the same growl notification will be reused for updates,
  # instead of a new growl window for every posting.
  @@current_directory_name = Dir.pwd.match(/([^\/]+)\z/).to_s
  def self.growl(title, msg, img, pri=0)
    title += " in #{@@current_directory_name}"
    msg += " at #{Time.now}"
    system "growlnotify -n autotest --image #{img} -p #{pri} -m #{msg.inspect} #{title}"
  end

  IMAGE_ROOT = "~/.autotest_images"

  Autotest.add_hook :initialize do  |at|
    growl "autotest running", "Started", "#{IMAGE_ROOT}/pass.png"
  end

  Autotest.add_hook :red do |at|
#     failures = $~[3].to_i
#     errors = $~[4].to_i
#     cnt = [(9 + failures + errors) / 10 * 10, 50].min
#     growl "FAIL", "#{output}", "#{image_root}/fail#{cnt}.png"
    output = results.slice(/(\d+)\s*examples,\s*(\d+)\s*failures/)
    failures = $~[2].to_i
    cnt = [(9 + failures) / 10 * 10, 50].min
    growl "Tests Failed", "#{at.files_to_test.size} tests failed", "#{IMAGE_ROOT}/fail#{cnt}.png"
  end

  Autotest.add_hook :green do |at|
    growl "Tests Passed", "Tests passed", "#{IMAGE_ROOT}/pass.png" if at.tainted
  end

  Autotest.add_hook :all_good do |at|
    growl "Tests Passed", "All tests passed", "#{IMAGE_ROOT}/pass.png" if at.tainted
  end

  Autotest.add_hook :initialize do |at|
    %w{.hg .git .svn config test nbproject stories log vendor public script db Rakefile Capfile README spec/spec.opts spec/rcov.opts autotest svn-commit .DS_Store }.each do |exception|
      at.add_exception(exception)
    end
  end
end
